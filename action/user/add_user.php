<?php define('RIGHT',TRUE);require_once '../../base_config.php';session_start();session_write_close();if(!$main->check_shell($_SESSION['shell'],$_SESSION['login_id'])){	$main->re_url('../../login.php');}if($main->check_shell($_SESSION['shell'],$_SESSION['login_id'])){	if ( !$_SESSION['login_id'] )	{		$main->re_url('../../login.php');	}	else	{		require_once '../../model/assign/assign.class.php';		$msg = new assign;		$prompt="";		$err1="";		$err=array();		$err['login_id']="*必填";		$err['name']="*必填";		$err['passwd']="*必填";		$err['passwd2']="*必填";		$err['dept']="*必填";		$err['office_phone']="*必填";		$err['tel1']="*必填";		$data=array();		$sql="select * from `admin` where `login_id`='{$_SESSION['login_id']}'";		$info=$db->get_one($sql);		if($_SESSION['right']==1)		{			$title="添加管理员"; 			$sql="select id,name,path,concat(path,'-',id) as bpath from dept order by bpath";			$dept_list=$db->get_all($sql);			foreach( $dept_list as $key => $value )			{				$dept_list[$key]['count']=2*(count(explode('-',$value['bpath']))-2);			}		}		else		{			$title="添加用户";		}		if ($_SERVER['REQUEST_METHOD'] == 'POST')		{			$login_id=$main->post('login_id');			$sql="select * from `admin` where `login_id`='$login_id'";			$try=$db->get_one($sql);			if($try)			{				$err1=$err['login_id']="该登陆id已被使用，请使用其他登录名";			}			$name=$main->post('name');			$passwd=$main->post('passwd');			$passwd2=$main->post('passwd2');			$dept=$main->post('dept');			$office_phone=$main->post('office_phone');			$tel_1=$main->post('tel1');			$tel_2=$main->post('tel2');			$email=$main->post('email');			if(!$login_id)			{				$err1=$err['login_id']="登陆id不能为空";			}			if(!$name)			{				$err1=$err['name']="姓名不能为空";			}			if(!$passwd)			{				$err1=$err['passwd']="请输入密码";			}			if(!$passwd2)			{				$err1=$err['passwd2']="请再次输入密码";			}			if($passwd!=$passwd2)			{				$err1=$err['passwd2']="两次密码不一致";			}			if($info['pid']=='0')			{				if(!$dept)				{					$err1=$err['dept']="请选择所属部门";				}			}			else			{				$dept=$info['dept'];			}			if(!$office_phone)			{				$err1=$err['office_phone']="办公电话不能为空";			}			else			{				if(!preg_match("/^((\+?[0-9]{2,4}\-[0-9]{3,4}\-)|([0-9]{3,4}\-))?([0-9]{7,8})(\-[0-9]+)?$/",$office_phone))				{					$err1=$err['office_phone']="请输入正确的电话号码";				}			}			if(!$tel_1)			{				$err1=$err['tel1']="请输入手机号码";			}			else			{				if(!preg_match("/^13[0-9]{1}[0-9]{8}$|15[012356789]{1}[0-9]{8}$|18[056789]{1}[0-9]{8}$/",$tel_1))				{					$err1=$err['tel1']="请输入正确的手机号码";				}			}			if($tel_2&&(!preg_match("/^13[0-9]{1}[0-9]{8}$|15[012356789]{1}[0-9]{8}$|18[056789]{1}[0-9]{8}$/",$tel_2)))			{				$err1=$err['tel2']="请输入正确的手机号码";			}			if(!$err1)			{				$data['login_id']=$login_id;				$data['name']=$name;				$data['dept']=$dept;				$data['office_phone']=$office_phone;				$data['tel_1']=$tel_1;				$data['tel_2']=$tel_2;				$data['email']=$email;				$data['pid']=$info['id'];				$pri=new privilege($_SESSION['login_id'],$db,$main);				$data['path']=$pri->get_kpath();				$data['passwd']=md5($passwd);				$db->insert('admin',$data);				$sql="select * from `admin` where `login_id`='$login_id'";				$fin=$db->get_one($sql);				$msg->add_one_note($fin['id'],$fin['dept'],$db);				if($_SESSION['right']==1)				{					$prompt="添加管理员成功";				}				if($_SESSION['right']==2)				{					$prompt="添加用户成功";				}			}		}	}}$smarty->assign('error',$err);$smarty->assign('dept_list',$dept_list);$smarty->assign('pid',$info['pid']);$smarty->assign('login_id',$login_id);$smarty->assign('name',$name);$smarty->assign('dept',$dept);$smarty->assign('office_phone',$office_phone);$smarty->assign('tel_1',$tel_1);$smarty->assign('tel_2',$tel_2);$smarty->assign('email',$email);$smarty->assign('prompt',$prompt);$smarty->assign('title',$title);$smarty->assign('content','user/add_user');$smarty->assign('js_display',3);$smarty->display('index.html');